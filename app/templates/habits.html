{% extends "base.html" %}
{% block title %}My Habits{% endblock %}
{% block content %}

  <h2 class="title">Habit Tracker</h2>

  {% if current_user.role != 'admin' %}
    <form method="post" action="{{ request.url_for('add_habit_route') }}" class="form">
      <div class="form-group">
        <label for="name">Tên habit</label>
        <input id="name" name="name" placeholder="Ví dụ: Uống nước" required />
      </div>
      <div class="form-group">
        <label for="description">Mô tả</label>
        <input id="description" name="description" placeholder="(tùy chọn)" />
      </div>
      <div class="form-group">
        <label for="frequency">Tần suất</label>
        <select id="frequency" name="frequency">
          <option value="daily">Hàng ngày</option>
          <option value="monthly">Hàng tháng</option>
          <option value="yearly">Hàng năm</option>
        </select>
      </div>
      <button class="btn" type="submit">Add Habit</button>
    </form>
  {% endif %}

  {# BẢNG DAILY #}
  {% if daily_habits %}
    <h3>Hàng ngày</h3>
    <table class="sheet">
      <thead>
        <tr>
          <th>Habit</th>
          <th>Streak</th>
          {% for d in header_daily %}
            <th>{{ ["T2","T3","T4","T5","T6","T7","CN"][loop.index0] }}</th>
          {% endfor %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for ctx in daily_habits %}
          <tr>
            <td>{{ ctx.habit.name }}</td>
            <td>
              {% if ctx.current_streak > 0 %}
                🔥 {{ ctx.current_streak }}
              {% else %}
                –
              {% endif %}
            </td>
            {% for d in header_daily %}
              {% set key = d.isoformat() %}
              <td>
                <form method="post"
                      action="{{ request.url_for('check_habit', habit_id=ctx.habit.id) }}">
                  <input type="hidden" name="the_date" value="{{ key }}" />
                  <input type="checkbox"
                         {% if key in ctx.checked %}checked{% endif %}
                         onchange="this.form.submit()" />
                </form>
              </td>
            {% endfor %}
            <td class="actions">
              {% if current_user.role == 'admin' or current_user.id == ctx.habit.owner_id %}
                <a href="{{ request.url_for('edit_habit_page', habit_id=ctx.habit.id) }}"
                   class="btn-edit btn-sm">Edit</a>
                <form data-method="DELETE" data-url="{{request.url_for('delete_route', habit_id=ctx.habit.id)}}" data-redirect="{{request.url_for('list_habits')}}"
                      data-confirm="Do you want to delete habit">
                  <button class="btn-sm btn-delete" type="submit">Delete</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# BẢNG MONTHLY #}
  {% if monthly_habits %}
    <h3>Hàng tháng</h3>
    <table class="sheet">
      <thead>
        <tr>
          <th>Habit</th>
          <th>Streak</th>
          {% for d in header_monthly %}
            <th>{{ d.strftime("%b") }}</th>
          {% endfor %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for ctx in monthly_habits %}
          <tr>
            <td>{{ ctx.habit.name }}</td>
            <td>
              {% if ctx.current_streak > 0 %}
                🔥 {{ ctx.current_streak }}
              {% else %}
                –
              {% endif %}
            </td>
            {% for d in header_monthly %}
              {% set key = d.isoformat() %}
              <td>
                <form method="post"
                      action="{{ request.url_for('check_habit', habit_id=ctx.habit.id) }}">
                  <input type="hidden" name="the_date" value="{{ key }}" />
                  <input type="checkbox"
                         {% if key in ctx.checked %}checked{% endif %}
                         onchange="this.form.submit()" />
                </form>
              </td>
            {% endfor %}
            <td class="actions">
              {% if current_user.role == 'admin' or current_user.id == ctx.habit.owner_id %}
                <a href="{{ request.url_for('edit_habit_page', habit_id=ctx.habit.id) }}"
                   class="btn-edit btn-sm">Edit</a>
                <form data-method="DELETE" data-url="{{request.url_for('delete_route', habit_id=ctx.habit.id)}}" data-redirect="{{request.url_for('list_habits')}}"
                      data-confirm="Do you want to delete habit">
                  <button class="btn-sm btn-delete" type="submit">Delete</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# BẢNG YEARLY #}
  {% if yearly_habits %}
    <h3>Hàng năm</h3>
    <table class="sheet">
      <thead>
        <tr>
          <th>Habit</th>
          <th>Streak</th>
          {% for d in header_yearly %}
            <th>{{ d.year }}</th>
          {% endfor %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for ctx in yearly_habits %}
          <tr>
            <td>{{ ctx.habit.name }}</td>
            <td>
              {% if ctx.current_streak > 0 %}
                🔥 {{ ctx.current_streak }}
              {% else %}
                –
              {% endif %}
            </td>
            {% for d in header_yearly %}
              {% set key = d.isoformat() %}
              <td>
                <form method="post"
                      action="{{ request.url_for('check_habit', habit_id=ctx.habit.id) }}">
                  <input type="hidden" name="the_date" value="{{ key }}" />
                  <input type="checkbox"
                         {% if key in ctx.checked %}checked{% endif %}
                         onchange="this.form.submit()" />
                </form>
              </td>
            {% endfor %}
            <td class="actions">
              {% if current_user.role == 'admin' or current_user.id == ctx.habit.owner_id %}
                <a href="{{ request.url_for('edit_habit_page', habit_id=ctx.habit.id) }}"
                   class="btn-edit btn-sm">Edit</a>
                <form data-method="DELETE" data-url="{{request.url_for('delete_route', habit_id=ctx.habit.id)}}" data-redirect="{{request.url_for('list_habits')}}"
                      data-confirm="Do you want to delete habit">
                  <button class="btn-sm btn-delete" type="submit">Delete</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

{% endblock %}